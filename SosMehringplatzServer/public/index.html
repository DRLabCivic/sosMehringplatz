<!doctype html>
<html>
	<head>
	<title>Pinpoint Mehringplatz</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<script src="libs/jquery-2.1.4.min.js"></script>
	<script src="libs/socket.io.js"></script>
	<script src="libs/d3.min.js"></script>
    <script src="libs/underscore-min.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/config.js"></script>
    <script src="js/vector.js"></script>
    <script src="js/field.js"></script>
    <script src="js/particle.js"></script>
    <script src="js/particleSystem.js"></script>
    <script src="js/audioPlayer.js"></script>
	<link rel="stylesheet" type="text/css" href="style.css"></link>
	<script type="html/template" id='popupTemplate'>
        <% if (author.image) { %>
        <div class="circleImage" style="background-image:url(<%= path+author.image %>)"></div>
        <% } %>
        <div class="popupText">
            <h1><%= typeName %></h1> 
            <p><%= content.text %></p>
            <% if (content.recording) { %>
            <p class="image"><img src="images/speaker.png"/></p>
            <% } %>
            <% if (author.name) { %>
            <p class="author">von <%= author.name %></p>
            <% } %>
        </div>
    </script>
	</head>
	<body>
        <div class="page">
            <div id="svg">
            </div>
            
            <div id="flash-overlay" class="flash">
            </div>
            <div class="header">
                <a href="#about">&raquo; ÜBER DIE AKTION</a>
                <a href="#manifest">&raquo; MANIFEST</a>
                <div class="avoid-clicks">
                    <h1>PINPOINT MEHRINGPLATZ</h1>
                    <span class="gray">WAS WIR SCHON IMMER ÜBER DIE BAUSTELLE SAGEN WOLLTEN</span>
                </div>
            </div>
            <div class="footer avoid-clicks">
                <img src="images/logos.png"/>
            </div>
            <div id="popup">
            </div>
        </div>
        <div id="about">
            <div class="content">
                <h1>ÜBER DIE AKTION</h1>
                <div class="images">
                    <img src="images/about1.jpg"/>
                    <img src="images/about2.jpg"/>
                    <img src="images/about3.jpg"/>
                    <img src="images/about4.jpg"/>
                </div>
                <div class="text black">
                <p>Die Community-Now-Aktion hat im Rahmen des Mehringplatz Straßenfestes 2015 am 26.9.2015 stattgefunden. Das Thema war die Langzeitbausselle inmitten des Mehringplatzes.</p>
                <p>Die Langzeitbaustelle haben wir zum Thema gemacht, da es für viele Nachbarinnen und Nachbarn des Mehringplatzes als Belastung wahrgenommen wird.</p>
                <p>Wir haben die Stimmen und Eindrücke der Nachbarschaft gesammelt, um damit die Forderungen der Nachbarschaft zu bündeln und zu stärken. Wir übergeben die Forderungen an verschiedene Interessensträger, Gremien und Initiativen, damit wir sie in ihrer Zielsetzung stärken können.</p>
                <p>Zudem treffen wir uns mit den involvierten Parteien mit dem Ziel eine schnellere Fertigstellung der Baustelle oder zumindest eine bessere Informationspolitik zu bewirken.
                </p>

            </div>    
        </div>
        <div id="manifest">
            <div class="content">
                <h1>MANIFEST</h1>
                <div class="submission-list">
                    <div class="submission right">
                        <div class="circle red">
                        </div>
                        <p>Der Baulärm ist unerträglich.</p>
                    </div>
                    <div class="submission left">
                        <div class="circle red "><img src="images/manifest/2.jpg"/></div>
                        <p>Die Baustelle finde ich nicht gut.</p>
                    </div>
                     <div class="submission right">
                        <div class="circle red "><img src="images/manifest/3.jpg"/></div>
                        <p>Durch die Baustelle wird mir der Weg zur Schule versperrt, ich will nicht mehr außen rumgehen.</p>
                    </div>
                    <div class="submission left">
                        <div class="circle red "></div>
                        <p>Die Baustelle dauert so lange. Nach 3 Jahren sollte sie fertig sein.</p>
                    </div>
                    <div class="submission right">
                        <div class="circle red "><img src="images/manifest/5.jpg"/></div>
                        <p>Ich will mich beschweren, dass es immer wenn ich morgens rausgehe, und ihr baut, es so nach Teer stinkt. Da kann man sich gar nicht konzentrieren und man kann nicht mehr das Fenster aufmachen, weil es so laut ist.</p>
                    </div>
                    <div class="submission left">
                        <div class="circle red "></div>
                        <p>Ihr könnt mal den Zaun aufs Minimalste verkleinern und ihn dann auch so lassen. Immer wenn Ihr etwas verändert, kann man den Platz nicht mehr nutzen.</p>
                    </div>
                    <div class="submission right">
                        <div class="circle red "><img src="images/manifest/7.jpg"/></div>
                        <p>Der Geruch nervt. Ihr müsst schneller machen.</p>
                    </div>
                    <div class="submission left">
                        <div class="circle red "><img src="images/manifest/8.jpg"/></div>
                        <p>Es ist viel zu laut und es nervt..</p>
                    </div>
                    <div class="submission right">
                        <div class="circle red "></div>
                        <p>Ich komme aus Argentinien und wohne hier seit 4 Jahren. Ich habe nie etwas anderes als die Baustelle gesehen. Ich würde diese Fläche gern für meine kinder als Spielplatz nutzen. Ich verstehe nicht, wie lange das dauert.</p>
                    </div>
                    <div class="submission left">
                        <div class="circle red "><img src="images/manifest/9.jpg"/></div>
                        <p>Die Baustelle könnt ihr schneller machen. Wir warten alle.</p>
                    </div>
                    <div class="submission right">
                        <div class="circle red "><img src="images/manifest/10.jpg"/></div>
                        <p>Es dauert viel zu lange. Wieso machen Sie so lange? Ich will, dass Sie schneller machen, sonst hole ich die Polizei!</p>
                    </div>
                    <div class="submission left">
                        <div class="circle red "><img src="images/manifest/11.jpg"/></div>
                        <p>Der, der die Baustelle gebaut hat, soll weggehen. Ihr müsst Euch beeilen.</p>
                    </div>
                    <div class="submission right">
                        <div class="circle yellow"><img src="images/manifest/12.jpg"/></div>
                        <p>Ich wollte fragen, wie lange sol Baustelle noch eine Baustelle sein wird, und wann wir endlich darüber informiert werden, warum ein Sandhügel von der linken auf die rechte Seite geschaufelt wird und von der rechten zur linken Seite?</p>
                    </div>
                    <div class="submission left">
                        <div class="circle yellow"></div>
                        <p>Stellt der Baulärm einen Mietmangel dar?</p>
                    </div>
                    <div class="submission right">
                        <div class="circle yellow"><img src="images/manifest/17.jpg"/></div>
                        <p>Warum ist die Baustelle da?</p>
                    </div>
                    <div class="submission left">
                        <div class="circle yellow"></div>
                        <p>Arbeitet Ihr auch samstags und sonntags?</p>
                    </div>
                    <div class="submission right">
                        <div class="circle yellow"><img src="images/manifest/16.jpg"/></div>
                        <p>Wann ist das fertig? Wie lange dauert das?</p>
                    </div>
                    <div class="submission left">
                        <div class="circle yellow"><img src="images/manifest/14.jpg"/></div>
                        <p>Wann ist die Baustelle fertig?</p>
                    </div>
                    <div class="submission right">
                        <div class="circle yellow"><img src="images/manifest/18.jpg"/></div>
                        <p>Hallo liebe Baustelle. Ich wollte mal fragen, wie lange du noch hier bleibst? Ich mag ja alle Menschen, aber du könntest langsam mal sagen wie lange du hier noch bleiben willst. und kein Mensch weiß es und keiner weiß, wen man fragen kann. Danke und Tschau.</p>
                    </div>
                    <div class="submission left">
                        <div class="circle yellow"><img src="images/manifest/19.jpg"/></div>
                        <p>Ich frag mich wann die Baustelle weg ist und wann ich sterbe.</p>
                    </div>
                    <div class="submission right">
                        <div class="circle green"></div>
                        <p>Es soll einen Park am Mehringplatz geben. Die Baustelle soll endlich mal fertig sein.</p>
                    </div>
                    <div class="submission left">
                        <div class="circle green"><img src="images/manifest/21.jpg"/></div>
                        <p>Es soll einen Spielplatz geben.</p>
                    </div>
                    <!--<div class="submission right">
                        <div class="circle green"><img src="images/manifest/22.jpg"/></div>
                        <p></p>
                    </div>
                    <div class="submission left">
                        <div class="circle green"><img src="images/manifest/23.jpg"/></div>
                        <p></p>
                    </div>-->
                    <div class="submission right">
                        <div class="circle green"><img src="images/manifest/24.jpg"/></div>
                        <p>Einen Wald</p>
                    </div>
                    <div class="submission left">
                        <div class="circle green"><img src="images/manifest/25.jpg"/></div>
                        <p>Ich habe eine Idee. und zwar mit den hässlichen Bauzäunen hier. und ich habe eine Idee, was man damit machen kann. Ruf mich an. Tschüss</p>
                    </div>
                    <div class="submission right">
                        <div class="circle green"><img src="images/manifest/26.jpg"/></div>
                        <p>Eine Wippe.</p>
                    </div>
                    <div class="submission left">
                        <div class="circle green"><img src="images/manifest/27.jpg"/></div>
                        <p>hallo, hier ist Jason. Baustelle soll fertig werden. Es soll einen Spielplatz und Bänke geben, und eine schöne Wiese.</p>
                    </div>
                    <div class="submission right">
                        <div class="circle green"><img src="images/manifest/28.jpg"/></div>
                        <p>Hundepark, Spielplatz oder nix</p>
                    </div>
                    <div class="submission left">
                        <div class="circle green"><img src="images/manifest/29.jpg"/></div>
                        <p>Ihr müsst schneller sein, anstatt in 4 Jahren Verbesserung vorzunehmen. Es soll einen Rummel oder Spielplatz geben/p>
                    </div>
                    <div class="submission right">
                        <div class="circle green"><img src="images/manifest/30.jpg"/></div>
                        <p>Ich wünsche mir, dass die Baustelle bald fertig ist und dass es einen schönen Park und Bänke gibt.</p>
                    </div>
                </div>
        </div>
    	<script>

            /*  vars */

            var w = window.innerWidth,
                h = window.innerHeight;
                colors = ['#FFFF66','#66FF66','#fd693c']

            var popupTimer = null;
            var popupTemplate = _.template($("#popupTemplate").html());

            /* Set up Canvas */

            var svg = d3.select("#svg").append("svg:svg")

            /* Set up audioplayer */

            var audioPlayer = null;

            /* Set up particle system */

            var system = new ParticleSystem(svg);
            // add center of gravity
            system.addField(new Field(
                new Vector(w/2,h/2),
                2,
                0.1
            ));
            system.addField(new Field(
                new Vector(w/2,h/2),
                -10,
                0.8,
                'plateau'
            ));

            /* Event handlers */

            function onResize() {
                w = $('body').width();
                h = window.innerHeight;

                svg
                .attr("width", w)
                .attr("height", h);

                $('.page')
                    .width(w)
                    .height(h);

                system.moveField(0,new Vector(w/2,h/2));
                system.moveField(1,new Vector(w/2,h/2));
            }

            $(window).on('resize',onResize);

            $( document ).ready(function() {
                onResize();

                //randomize manifest list
                $('.submission.left .circle').each(function(ele) {
                    var margin = Math.random()*20
                    $(this).css('margin-left',margin+'%');
                });
                $('.submission.right .circle').each(function(ele) {
                    var margin = Math.random()*20
                    $(this).css('margin-right',margin+'%');
                });
            });
            
            //mouseclickhandler
            svg.on("click", function() {
                var p = d3.mouse(this);
                var particleIndex = system.findParticle(p[0],p[1]);
                if (particleIndex) {
                    popupSubmission(particleIndex,false);
                }
            });

            /* Animation Loop */
             
            function loop() {
                system.update();
                queue();
            }
             
             
            function queue() {
                window.requestAnimationFrame(loop);
            }
             
            loop();

            /* SUBMISSION FUNCTIONS */

            function popupSubmission(id,closeCallback) {

                closePopup(false);

                system.openPopup(id,function(particle) {

                    var submission = particle.data;

                    var div = $('#popup');

                    //open div popup
                    div.css({left: particle.pos.x - div.width()/2, top: particle.pos.y - div.height()/2})
                    div.html(popupTemplate(particle.data));
                    div.show();

                    if (submission.content.recording) {
                        audioPlayer = new AudioPlayer(submission.path+submission.content.recording, function() {
                            closePopup(closeCallback);
                        });
                    } else {
                        setTimeout(function() {
                            closePopup(closeCallback);
                        },Config.popupShowTime)
                    }
                });
            };

            function closePopup(callback) {

                console.log(callback)
                var div = $('#popup');
                div.hide();
                if (audioPlayer) {
                    audioPlayer.stop();
                    audioPlayer = null;
                }
                system.closePopup(callback);
            };

            function addSubmission(submission,fromEverywhere) {

                var y = 0;
                if (fromEverywhere)
                    var y = Math.random()*h;

                //attach path
                submission.path = Config.uploadFolder+'/'+submission._id+'/';
                submission.typeName = Utils.convertType(submission.type);

                system.emit(new Particle({
                    position: new Vector(Math.random()*w,y),
                    radius: 15 + Math.random()*15,
                    id: submission._id,
                    data: submission
                }));
            };

            function addNewSubmission(submission) {

                setTimeout(function() {
                    flash();
                    addSubmission(submission);
                },2000) //add after 2 seconds
            };

            /* drawing functions */

            function flash() {
                $('#flash-overlay').show();
                setTimeout(function() {
                    $('#flash-overlay').hide();
                },500);
            }

            /* SERVER COMMUNICATION */

            var socket = io();
            socket.on('connect', function() {
                console.log('socket connected');
                //get initial list
                socket.emit('submissions:list'); 
            });

            socket.on('submissions:new', function(res) {
                console.log('new submission received');
                console.log(res.data);
                addNewSubmission(res.data);
            });

            // only load the initial list once
            socket.once('submissions:list', function(res) {
                res.data.forEach( function(elem) {
                    addSubmission(elem,true);
                });
            });

    		
    	</script>
	</body>
</html>